<div class="modal-header">
    <h3>{{ t('expenses.new_expense') if t is defined else 'Nuevo Gasto' }}</h3>
    <button type="button" class="btn-close" onclick="closeExpenseModal()">&times;</button>
</div>

<form
    class="expense-form"
    hx-post="/contraparte/{{ project.id }}/gastos"
    hx-target="#counterpart-content"
    hx-swap="innerHTML"
    hx-on::after-request="if(event.detail.successful) closeExpenseModal()"
>
    <input type="hidden" name="funding_source_id" value="{{ funding_source.id }}">
    <div class="modal-body">
        <!-- Notice Banner -->
        <div class="alert alert-info">
            <i data-lucide="info"></i>
            <span>{{ t('expenses.counterpart_notice') if t is defined else 'Este gasto se enviara directamente a revision por el coordinador del proyecto.' }}</span>
        </div>

        <!-- Balance Warning -->
        <div id="balance-warning" class="alert alert-warning" style="display: none;"></div>

        <!-- Basic Info -->
        <div class="form-section">
            <div class="form-grid">
                <div class="form-group">
                    <label for="fecha_factura">{{ t('expenses.invoice_date') if t is defined else 'Fecha Factura' }} *</label>
                    <input
                        type="date"
                        id="fecha_factura"
                        name="fecha_factura"
                        required
                    >
                </div>
                <div class="form-group">
                    <label for="budget_line_id">{{ t('expenses.budget_line') if t is defined else 'Partida Presupuestaria' }} *</label>
                    <select
                        id="budget_line_id"
                        name="budget_line_id"
                        required
                        onchange="checkBudgetBalance()"
                    >
                        <option value="">{{ t('expenses.select_line') if t is defined else 'Seleccionar partida...' }}</option>
                        {% for line in budget_lines %}
                        <option
                            value="{{ line.id }}"
                            data-disponible-espana="{{ line.disponible_espana }}"
                            data-disponible-terreno="{{ line.disponible_terreno }}"
                            data-spain-only="{{ 'true' if line.is_spain_only else 'false' }}"
                        >
                            {{ line.code }} - {{ t('bl.' + funder_code + '.' + line.code) if t is defined and funder_code else line.name }}
                            (Disp: {{ "{:,.2f}".format(line.disponible_espana) }} ESP / {{ "{:,.2f}".format(line.disponible_terreno) }} TER)
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label for="concepto">{{ t('expenses.concept') if t is defined else 'Concepto' }} *</label>
                <input
                    type="text"
                    id="concepto"
                    name="concepto"
                    maxlength="500"
                    required
                    placeholder="{{ t('expenses.concept_placeholder') if t is defined else 'Descripcion del gasto' }}"
                >
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="expedidor">{{ t('expenses.issuer') if t is defined else 'Expedidor' }} *</label>
                    <input
                        type="text"
                        id="expedidor"
                        name="expedidor"
                        maxlength="200"
                        required
                        placeholder="{{ t('expenses.issuer_placeholder') if t is defined else 'Nombre del proveedor' }}"
                    >
                </div>
                <div class="form-group">
                    <label for="persona">{{ t('expenses.person') if t is defined else 'Persona' }}</label>
                    <input
                        type="text"
                        id="persona"
                        name="persona"
                        maxlength="200"
                        placeholder="{{ t('expenses.person_placeholder') if t is defined else 'Persona responsable (opcional)' }}"
                    >
                </div>
            </div>
        </div>

        <!-- Amounts -->
        <div class="form-section">
            <h4>{{ t('expenses.amounts') if t is defined else 'Importes' }}</h4>
            <div class="form-grid form-grid-3">
                <div class="form-group">
                    <label for="cantidad_original">{{ t('expenses.original_amount') if t is defined else 'Importe Original' }} *</label>
                    <input
                        type="number"
                        id="cantidad_original"
                        name="cantidad_original"
                        step="0.01"
                        min="0"
                        required
                        onchange="updateCurrencyConversion()"
                        onkeyup="updateCurrencyConversion()"
                    >
                </div>
                <div class="form-group">
                    <label for="moneda_original">{{ t('expenses.currency') if t is defined else 'Moneda' }}</label>
                    <select
                        id="moneda_original"
                        name="moneda_original"
                        onchange="updateCurrencyConversion()"
                    >
                        <option value="EUR" selected>EUR</option>
                        <option value="USD">USD</option>
                        <option value="GBP">GBP</option>
                        <option value="MAD">MAD</option>
                        <option value="XOF">XOF</option>
                        <option value="XAF">XAF</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo_cambio">{{ t('expenses.exchange_rate') if t is defined else 'Tipo de Cambio' }}</label>
                    <input
                        type="number"
                        id="tipo_cambio"
                        name="tipo_cambio"
                        step="0.000001"
                        min="0"
                        placeholder="1.000000"
                        onchange="updateCurrencyConversion()"
                        onkeyup="updateCurrencyConversion()"
                    >
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="cantidad_euros">{{ t('expenses.amount_eur') if t is defined else 'Importe en EUR' }} *</label>
                    <input
                        type="number"
                        id="cantidad_euros"
                        name="cantidad_euros"
                        step="0.01"
                        min="0"
                        required
                        onchange="updateImputeAmount(); checkBudgetBalance()"
                        onkeyup="updateImputeAmount(); checkBudgetBalance()"
                    >
                </div>
                <div class="form-group">
                    <label for="porcentaje">{{ t('expenses.imputation_pct') if t is defined else '% Imputacion' }}</label>
                    <input
                        type="number"
                        id="porcentaje"
                        name="porcentaje"
                        value="100"
                        step="0.01"
                        min="0"
                        max="100"
                        onchange="updateImputeAmount(); checkBudgetBalance()"
                        onkeyup="updateImputeAmount(); checkBudgetBalance()"
                    >
                </div>
            </div>
            <div class="imputable-display">
                <span class="imputable-label">{{ t('expenses.imputable_amount') if t is defined else 'Importe imputable:' }}</span>
                <span id="cantidad_imputable_display" class="imputable-value">0.00 EUR</span>
            </div>
        </div>

        <!-- Location -->
        <div class="form-section">
            <div class="form-group">
                <label>{{ t('expenses.location') if t is defined else 'Ubicacion' }} *</label>
                <div class="radio-group">
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="ubicacion"
                            value="espana"
                            onchange="checkBudgetBalance()"
                        >
                        <span>{{ t('expenses.spain') if t is defined else 'Espana' }}</span>
                    </label>
                    <label class="radio-label">
                        <input
                            type="radio"
                            name="ubicacion"
                            value="terreno"
                            checked
                            onchange="checkBudgetBalance()"
                        >
                        <span>{{ t('expenses.field') if t is defined else 'Terreno' }}</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Notes -->
        <div class="form-section">
            <div class="form-group">
                <label for="observaciones">{{ t('expenses.notes') if t is defined else 'Observaciones' }}</label>
                <textarea
                    id="observaciones"
                    name="observaciones"
                    rows="3"
                    placeholder="{{ t('expenses.notes_placeholder') if t is defined else 'Notas adicionales (opcional)' }}"
                ></textarea>
            </div>
        </div>
    </div>

    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeExpenseModal()">{{ t('expenses.cancel') if t is defined else 'Cancelar' }}</button>
        <button type="submit" class="btn btn-primary">{{ t('expenses.submit_expense') if t is defined else 'Registrar Gasto' }}</button>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateImputeAmount();
    checkBudgetBalance();
});
</script>
