<tr class="transfer-row" id="transfer-row-{{ transfer.id }}">
    <td class="col-numero">
        <span class="numero-badge">{{ transfer.numero }}/{{ transfer.total_previstas }}</span>
        {% if transfer.es_ultima %}
        <span class="ultima-badge" title="Ultima transferencia">U</span>
        {% endif %}
    </td>
    <td class="col-date">
        {% if transfer.fecha_emision %}
        {{ transfer.fecha_emision.strftime('%d/%m/%Y') }}
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td class="col-date">
        {% if transfer.fecha_recepcion %}
        {{ transfer.fecha_recepcion.strftime('%d/%m/%Y') }}
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td class="col-amount">
        <span class="amount-primary">{{ "{:,.2f}".format(transfer.importe_euros) }}</span>
        {% if transfer.gastos_transferencia > 0 %}
        <span class="gastos-badge" title="Gastos: {{ "{:,.2f}".format(transfer.gastos_transferencia) }} EUR">
            -{{ "{:,.2f}".format(transfer.gastos_transferencia) }}
        </span>
        {% endif %}
    </td>
    <td class="col-exchange">
        {% if transfer.tipo_cambio_local %}
        {{ "{:,.4f}".format(transfer.tipo_cambio_local) }}
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td class="col-amount">
        {% if transfer.importe_moneda_local %}
        <span class="amount-local">{{ "{:,.2f}".format(transfer.importe_moneda_local) }}</span>
        <span class="moneda-badge">{{ transfer.moneda_local or '?' }}</span>
        {% else %}
        <span class="text-muted">-</span>
        {% endif %}
    </td>
    <td class="col-estado">
        <span class="estado-transfer-badge estado-transfer-{{ transfer.estado.value }}">
            {{ transfer.estado.value|title }}
        </span>
    </td>
    <td class="col-documents">
        <div class="document-buttons">
            {# Emission document - available from aprobada state (required before emission) #}
            {% if transfer.estado.value in ['aprobada', 'emitida', 'recibida', 'cerrada'] %}
                {% if transfer.documento_emision_filename %}
                <a
                    href="/projects/{{ project.id }}/transfers/{{ transfer.id }}/document/emision"
                    class="doc-badge doc-attached"
                    title="Descargar: {{ transfer.documento_emision_filename }}"
                    target="_blank"
                >
                    <span class="doc-icon">E</span>
                </a>
                {% else %}
                <button
                    type="button"
                    class="doc-badge doc-missing"
                    title="Subir documento de emision (requerido para emitir)"
                    hx-get="/projects/{{ project.id }}/transfers/{{ transfer.id }}/upload-modal?doc_type=emision"
                    hx-target="#transfer-upload-modal-content"
                    hx-trigger="click"
                    onclick="openTransferUploadModal()"
                >
                    <span class="doc-icon">E</span>
                </button>
                {% endif %}
            {% else %}
                <span class="doc-badge doc-disabled" title="Disponible tras aprobacion">
                    <span class="doc-icon">E</span>
                </span>
            {% endif %}

            {# Reception document - available from emitida state (required before reception) #}
            {% if transfer.estado.value in ['emitida', 'recibida', 'cerrada'] %}
                {% if transfer.documento_recepcion_filename %}
                <a
                    href="/projects/{{ project.id }}/transfers/{{ transfer.id }}/document/recepcion"
                    class="doc-badge doc-attached"
                    title="Descargar: {{ transfer.documento_recepcion_filename }}"
                    target="_blank"
                >
                    <span class="doc-icon">R</span>
                </a>
                {% else %}
                <button
                    type="button"
                    class="doc-badge doc-missing"
                    title="Subir documento de recepcion (requerido para confirmar recepcion)"
                    hx-get="/projects/{{ project.id }}/transfers/{{ transfer.id }}/upload-modal?doc_type=recepcion"
                    hx-target="#transfer-upload-modal-content"
                    hx-trigger="click"
                    onclick="openTransferUploadModal()"
                >
                    <span class="doc-icon">R</span>
                </button>
                {% endif %}
            {% else %}
                <span class="doc-badge doc-disabled" title="Disponible tras emision">
                    <span class="doc-icon">R</span>
                </span>
            {% endif %}
        </div>
    </td>
    <td class="col-actions">
        <div class="action-buttons">
            {% if transfer.estado.value == 'solicitada' %}
            <!-- Can edit, delete, or approve -->
            <button
                type="button"
                class="btn-icon"
                title="Editar"
                hx-get="/projects/{{ project.id }}/transfers/{{ transfer.id }}/edit"
                hx-target="#transfer-modal-content"
                hx-trigger="click"
                onclick="openTransferModal()"
            >âœï¸</button>
            {% if user and user.rol and user.rol.value in ['director', 'coordinador'] %}
            <button
                type="button"
                class="btn-icon btn-success"
                title="Aprobar"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/approve"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
                hx-confirm="Â¿Aprobar esta transferencia?"
            >âœ“</button>
            {% endif %}
            <button
                type="button"
                class="btn-icon btn-danger"
                title="Eliminar"
                hx-delete="/projects/{{ project.id }}/transfers/{{ transfer.id }}"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
                hx-confirm="Â¿Eliminar esta transferencia?"
            >ğŸ—‘ï¸</button>
            {% elif transfer.estado.value == 'aprobada' %}
            <!-- Can edit, emit, or revert -->
            <button
                type="button"
                class="btn-icon"
                title="Editar"
                hx-get="/projects/{{ project.id }}/transfers/{{ transfer.id }}/edit"
                hx-target="#transfer-modal-content"
                hx-trigger="click"
                onclick="openTransferModal()"
            >âœï¸</button>
            {% if user and user.rol and user.rol.value in ['director', 'coordinador'] %}
            <button
                type="button"
                class="btn-icon btn-success"
                title="Confirmar emision"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/confirm-emission"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
                hx-confirm="Â¿Confirmar emision de esta transferencia?"
            >ğŸ“¤</button>
            {% endif %}
            <button
                type="button"
                class="btn-icon btn-warning"
                title="Revertir a solicitada"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/revert"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
            >â†©ï¸</button>
            {% elif transfer.estado.value == 'emitida' %}
            <!-- Can confirm reception or revert -->
            {% if user and user.rol and user.rol.value in ['director', 'coordinador'] %}
            <button
                type="button"
                class="btn-icon btn-success"
                title="Confirmar recepcion"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/confirm-reception"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
                hx-confirm="Â¿Confirmar recepcion de esta transferencia?"
            >ğŸ“¥</button>
            {% endif %}
            <button
                type="button"
                class="btn-icon btn-warning"
                title="Revertir a aprobada"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/revert"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
            >â†©ï¸</button>
            {% elif transfer.estado.value == 'recibida' %}
            <!-- Can close or revert -->
            {% if user and user.rol and user.rol.value in ['director', 'coordinador'] %}
            <button
                type="button"
                class="btn-icon btn-success"
                title="Cerrar"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/close"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
                hx-confirm="Â¿Cerrar esta transferencia?"
            >ğŸ”’</button>
            {% endif %}
            <button
                type="button"
                class="btn-icon btn-warning"
                title="Revertir a emitida"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/revert"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
            >â†©ï¸</button>
            {% elif transfer.estado.value == 'cerrada' %}
            <!-- Can only revert -->
            <button
                type="button"
                class="btn-icon btn-warning"
                title="Reabrir"
                hx-post="/projects/{{ project.id }}/transfers/{{ transfer.id }}/revert"
                hx-target="#transfers-content"
                hx-swap="outerHTML"
            >ğŸ”“</button>
            {% endif %}
        </div>
    </td>
</tr>
