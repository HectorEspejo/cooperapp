<div id="budget-content"
     hx-get="/projects/{{ project.id }}/budget"
     hx-trigger="budgetUpdated from:body"
     hx-target="#tab-presupuesto"
     hx-swap="innerHTML">
{% if budget.has_budget %}
    {% include "partials/projects/budget_table.html" %}
{% else %}
<div class="budget-init-form">
    <div class="empty-state budget-empty">
        <div class="empty-icon"><i data-lucide="bar-chart-3"></i></div>
        <h3>Sin presupuesto configurado</h3>
        <p>
            El financiador actual (<strong>{{ project.financiador.value }}</strong>) no tiene plantillas de presupuesto definidas,
            o el presupuesto no se ha inicializado correctamente.
        </p>
    </div>

    {% if user and user.rol and user.rol.value in ['director', 'coordinador'] %}
    <form
        class="init-budget-form"
        hx-post="/projects/{{ project.id }}/budget/initialize"
        hx-target="#tab-presupuesto"
        hx-swap="innerHTML"
    >
        <p class="help-text">
            Si deseas usar las plantillas de otro financiador, selecciona uno a continuacion:
        </p>
        <div class="form-group">
            <label for="funder_id">Financiador</label>
            <select name="funder_id" id="funder_id" required>
                <option value="">Selecciona un financiador...</option>
                {% for funder in funders %}
                <option value="{{ funder.id }}" {% if budget.funder_code == funder.code %}selected{% endif %}>
                    {{ funder.name }} ({{ funder.code }})
                </option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Inicializar Presupuesto</button>
    </form>
    {% endif %}
</div>
{% endif %}
</div>

<!-- Distribution Modal Container -->
<div id="distribution-modal" class="modal-overlay" style="display: none;" onclick="closeDistributionModal(event)">
    <div class="distribution-modal-content" onclick="event.stopPropagation()">
        <div id="distribution-modal-body">
        </div>
    </div>
</div>

<script>
function openDistributionModal() {
    var modal = document.getElementById('distribution-modal');
    if (modal && modal.parentElement !== document.body) {
        document.body.appendChild(modal);
    }
    modal.style.display = 'flex';
}

function closeDistributionModal(event) {
    if (event && event.target && event.target.id !== 'distribution-modal' && event.type === 'click') {
        return;
    }
    var modal = document.getElementById('distribution-modal');
    if (modal) {
        modal.style.display = 'none';
    }
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDistributionModal();
    }
});
</script>
