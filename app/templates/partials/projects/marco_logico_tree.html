{% set _t = t if t is defined else None %}
{% set _counterpart = is_counterpart if is_counterpart is defined else false %}
{% if framework and framework.specific_objectives %}
<div class="ml-tree">
    {% for objective in framework.specific_objectives %}
    <div class="ml-tree-node ml-objective" data-objective-id="{{ objective.id }}">
        <div class="ml-node-header">
            <button class="ml-toggle" onclick="toggleNode(this)">
                <i class="fas fa-chevron-down"></i>
            </button>
            <span class="ml-node-label">OE{{ objective.numero }}</span>
            <span class="ml-node-text">{{ tc('specific_objective', objective.id, 'descripcion', objective.descripcion) if tc is defined else objective.descripcion }}</span>
            {% if not _counterpart %}
            <div class="ml-node-actions">
                <button
                    class="btn btn-icon"
                    title="{{ _t('ml.add_result') if _t else 'Anadir Resultado' }}"
                    hx-get="/projects/{{ project.id }}/marco-logico/result-form?objective_id={{ objective.id }}"
                    hx-target="#indicator-modal-container"
                    hx-swap="innerHTML"
                    onclick="document.getElementById('indicator-modal-container').classList.add('active')"
                >+R</button>
                <button
                    class="btn btn-icon"
                    title="{{ _t('ml.add_indicator_title') if _t else 'Anadir Indicador' }}"
                    hx-get="/projects/{{ project.id }}/marco-logico/indicator-form?framework_id={{ framework.id }}&objective_id={{ objective.id }}"
                    hx-target="#indicator-modal-container"
                    hx-swap="innerHTML"
                    onclick="document.getElementById('indicator-modal-container').classList.add('active')"
                >+I</button>
                <button
                    class="btn btn-icon"
                    title="{{ _t('ml.edit_objective') if _t else 'Editar Objetivo' }}"
                    hx-get="/projects/{{ project.id }}/marco-logico/objective-form?objective_id={{ objective.id }}"
                    hx-target="#indicator-modal-container"
                    hx-swap="innerHTML"
                    onclick="document.getElementById('indicator-modal-container').classList.add('active')"
                ><i class="fas fa-pencil"></i></button>
                <button
                    class="btn btn-icon btn-danger"
                    title="{{ _t('ml.delete') if _t else 'Eliminar' }}"
                    hx-delete="/projects/objectives/{{ objective.id }}"
                    hx-target="#marco-logico-content"
                    hx-swap="innerHTML"
                    hx-confirm="{{ _t('ml.confirm_delete_objective') if _t else 'Eliminar este objetivo y todos sus elementos?' }}"
                ><i class="fas fa-xmark"></i></button>
            </div>
            {% endif %}
        </div>

        <!-- Objective Indicators -->
        {% if objective.indicators %}
        <div class="ml-indicators-inline">
            {% for indicator in objective.indicators %}
                {% include "partials/projects/marco_logico_indicator.html" %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Results -->
        <div class="ml-node-children">
            {% for result in objective.results %}
                {% include "partials/projects/marco_logico_result.html" %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="ml-empty">
    <p>{{ _t('ml.no_objectives') if _t else 'No hay objetivos especificos definidos.' }}</p>
    {% if not _counterpart %}
    <p class="text-muted">{{ _t('ml.click_add_objective') if _t else 'Haga clic en "+ Objetivo Especifico" para comenzar.' }}</p>
    {% endif %}
</div>
{% endif %}

<script>
function toggleNode(btn) {
    const node = btn.closest('.ml-tree-node');
    node.classList.toggle('collapsed');
}
</script>
