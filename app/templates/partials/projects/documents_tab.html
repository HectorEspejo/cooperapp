{% set _t = t if t is defined else None %}
{% set _counterpart = is_counterpart if is_counterpart is defined else false %}
<div class="documents-container" id="documents-content">
    <!-- Summary Stats -->
    <div class="documents-summary">
        <div class="summary-stats">
            <div class="summary-stat">
                <span class="stat-value">{{ summary.total }}</span>
                <span class="stat-label">{{ _t('docs.total') if _t else 'Total' }}</span>
            </div>
            <div class="summary-stat stat-success">
                <span class="stat-value">{{ summary.sellados }}</span>
                <span class="stat-label">{{ _t('docs.sealed') if _t else 'Sellados' }}</span>
            </div>
            <div class="summary-stat stat-warning">
                <span class="stat-value">{{ summary.pendientes_sellar }}</span>
                <span class="stat-label">{{ _t('docs.pending') if _t else 'Pendientes' }}</span>
            </div>
            <div class="summary-stat stat-info">
                <span class="stat-value">{{ summary.vinculados }}</span>
                <span class="stat-label">{{ _t('docs.linked') if _t else 'Vinculados' }}</span>
            </div>
            <div class="summary-stat">
                <span class="stat-value">{{ summary.huerfanos }}</span>
                <span class="stat-label">{{ _t('docs.unlinked') if _t else 'Sin vincular' }}</span>
            </div>
        </div>
        <div class="summary-amounts">
            <div class="amount-item">
                <span class="amount-label">{{ _t('docs.total_size') if _t else 'Tamano total:' }}</span>
                <span class="amount-value">{{ summary.tamano_total_human }}</span>
            </div>
        </div>
    </div>

    <!-- Upload Zone -->
    {% if (user and user.rol and user.rol.value in ['director', 'coordinador', 'tecnico_sede', 'gestor_pais']) or _counterpart %}
    <div class="documents-upload-section">
        <form
            id="document-upload-form"
            class="upload-form"
            hx-post="{% if _counterpart %}/contraparte/{{ project.id }}/documents{% else %}/projects/{{ project.id }}/documents{% endif %}"
            hx-target="#documents-content"
            hx-swap="innerHTML"
            hx-encoding="multipart/form-data"
        >
            <div class="upload-zone" id="upload-zone">
                <div class="upload-zone-content">
                    <span class="upload-icon"><i data-lucide="folder-open"></i></span>
                    <p class="upload-text">{{ _t('docs.drag_files') if _t else 'Arrastra archivos aqui o haz clic para seleccionar' }}</p>
                    <input
                        type="file"
                        name="file"
                        id="file-input"
                        class="upload-input"
                        accept="image/*,.pdf,.doc,.docx,.xls,.xlsx"
                        required
                    >
                </div>
            </div>
            <div class="upload-options">
                <div class="form-group">
                    <label for="categoria">{{ _t('docs.category') if _t else 'Categoria' }}</label>
                    <select name="categoria" id="categoria" required>
                        {% for cat in categorias %}
                        <option value="{{ cat.value }}">{{ categoria_nombres[cat.value] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label for="descripcion">{{ _t('docs.description_optional') if _t else 'Descripcion (opcional)' }}</label>
                    <input type="text" name="descripcion" id="descripcion" placeholder="{{ _t('docs.description_placeholder') if _t else 'Descripcion del documento...' }}">
                </div>
                <button type="submit" class="btn btn-primary" id="upload-btn" disabled>
                    {{ _t('docs.upload') if _t else 'Subir documento' }}
                </button>
            </div>
        </form>
    </div>
    {% endif %}

    <!-- Filters Bar -->
    {% if not _counterpart %}
    <div class="documents-filters">
        <form
            class="filters-form"
            hx-get="/projects/{{ project.id }}/documents/table"
            hx-target="#documents-table-container"
            hx-trigger="change"
        >
            <select name="categoria" class="filter-select">
                <option value="">{{ _t('docs.all_categories') if _t else 'Todas las categorias' }}</option>
                {% for cat in categorias %}
                <option value="{{ cat.value }}">{{ categoria_nombres[cat.value] }}</option>
                {% endfor %}
            </select>
            <select name="sellado" class="filter-select">
                <option value="">{{ _t('docs.all_statuses') if _t else 'Todos los estados' }}</option>
                <option value="true">{{ _t('docs.sealed_filter') if _t else 'Sellados' }}</option>
                <option value="false">{{ _t('docs.unsealed_filter') if _t else 'Sin sellar' }}</option>
            </select>
            <select name="vinculado" class="filter-select">
                <option value="">{{ _t('docs.all') if _t else 'Todos' }}</option>
                <option value="true">{{ _t('docs.linked_filter') if _t else 'Vinculados' }}</option>
                <option value="false">{{ _t('docs.unlinked_filter') if _t else 'Sin vincular' }}</option>
            </select>
        </form>
        <div class="filters-actions">
            <a
                href="/api/projects/{{ project.id }}/documents/zip"
                class="btn btn-secondary btn-sm"
                title="{{ _t('docs.download_zip_title') if _t else 'Descargar todos como ZIP' }}"
            >
                <i data-lucide="download"></i> {{ _t('docs.download_zip') if _t else 'Descargar ZIP' }}
            </a>
        </div>
    </div>
    {% endif %}

    <!-- Documents Table -->
    <div id="documents-table-container">
        {% include "partials/projects/documents_table.html" %}
    </div>

    <!-- Document Preview Modal Container -->
    <div id="document-preview-modal" class="modal-container"></div>
</div>

<script>
// Define project-specific preview function
function openDocumentPreview(documentId) {
    htmx.ajax('GET', '/projects/{{ project.id }}/documents/' + documentId + '/preview', {
        target: '#document-preview-modal',
        swap: 'innerHTML'
    }).then(function() {
        document.getElementById('document-preview-modal').classList.add('active');
    });
}

function closeDocumentPreview() {
    var modal = document.getElementById('document-preview-modal');
    if (modal) {
        modal.classList.remove('active');
        modal.innerHTML = '';
    }
}

// Initialize upload zone when tab loads
(function() {
    var uploadZone = document.getElementById('upload-zone');
    var fileInput = document.getElementById('file-input');
    var uploadBtn = document.getElementById('upload-btn');

    if (!uploadZone || !fileInput || !uploadBtn) return;

    uploadZone.addEventListener('click', function() {
        fileInput.click();
    });

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            uploadZone.classList.add('has-file');
            uploadZone.querySelector('.upload-text').textContent = this.files[0].name;
            uploadBtn.disabled = false;
        }
    });

    uploadZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadZone.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');

        if (e.dataTransfer.files.length > 0) {
            fileInput.files = e.dataTransfer.files;
            this.classList.add('has-file');
            this.querySelector('.upload-text').textContent = e.dataTransfer.files[0].name;
            uploadBtn.disabled = false;
        }
    });
})();
</script>
