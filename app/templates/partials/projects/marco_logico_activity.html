{% set _t = t if t is defined else None %}
{% set _counterpart = is_counterpart if is_counterpart is defined else false %}
<div class="ml-tree-node ml-activity" data-activity-id="{{ activity.id }}">
    <div class="ml-node-header ml-activity-header">
        <button class="ml-toggle" onclick="toggleNode(this)">
            <i data-lucide="chevron-down" class="toggle-icon"></i>
        </button>
        <span class="ml-node-label ml-activity-label">{{ activity.numero }}</span>
        <span class="ml-node-text">{{ tc('activity', activity.id, 'descripcion', activity.descripcion) if tc is defined else activity.descripcion }}</span>

        <!-- Activity Status -->
        <div class="ml-activity-status">
            <select
                class="ml-status-select estado-{{ activity.estado.value }}"
                hx-post="{% if _counterpart %}/contraparte/{{ project.id }}/activities/{{ activity.id }}/status{% else %}/projects/activities/{{ activity.id }}/status{% endif %}"
                hx-target="#marco-logico-content"
                hx-swap="innerHTML"
                hx-include="closest select"
                name="estado"
            >
                {% for estado in estados_actividad %}
                <option value="{{ estado.value }}" {% if activity.estado == estado %}selected{% endif %}>
                    {{ estado.value|replace('_', ' ')|title }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- Activity Dates -->
        <div class="ml-activity-dates">
            {% if activity.fecha_inicio_prevista or activity.fecha_fin_prevista %}
            <span class="date-planned" title="{{ _t('ml.planned_dates') if _t else 'Fechas previstas' }}">
                {{ activity.fecha_inicio_prevista.strftime('%d/%m/%Y') if activity.fecha_inicio_prevista else '?' }}
                -
                {{ activity.fecha_fin_prevista.strftime('%d/%m/%Y') if activity.fecha_fin_prevista else '?' }}
            </span>
            {% endif %}
            {% if activity.fecha_inicio_real or activity.fecha_fin_real %}
            <span class="date-real" title="{{ _t('ml.actual_dates') if _t else 'Fechas reales' }}">
                {{ activity.fecha_inicio_real.strftime('%d/%m/%Y') if activity.fecha_inicio_real else '?' }}
                -
                {{ activity.fecha_fin_real.strftime('%d/%m/%Y') if activity.fecha_fin_real else '?' }}
            </span>
            {% endif %}
        </div>

        <div class="ml-node-actions">
            {% if not _counterpart %}
            <button
                class="btn btn-icon {% if not activity.verification_sources and activity.estado.value == 'completada' %}btn-alert{% endif %}"
                title="{{ _t('ml.verification_sources') if _t else 'Fuentes de verificacion' }}{% if not activity.verification_sources and activity.estado.value == 'completada' %} ({{ _t('ml.no_sources') if _t else 'sin fuentes' }}){% endif %}"
                onclick="openVerificationModal('activity', {{ activity.id }})"
            >
                <i data-lucide="clipboard-list"></i>
                {% if activity.verification_sources %}
                <span class="source-count-badge">{{ activity.verification_sources|length }}</span>
                {% endif %}
            </button>
            <button
                class="btn btn-icon"
                title="{{ _t('ml.add_indicator_title') if _t else 'Anadir Indicador' }}"
                hx-get="/projects/{{ project.id }}/marco-logico/indicator-form?framework_id={{ framework.id }}&activity_id={{ activity.id }}"
                hx-target="#indicator-modal-container"
                hx-swap="innerHTML"
                onclick="document.getElementById('indicator-modal-container').classList.add('active')"
            >+I</button>
            {% endif %}
            <button
                class="btn btn-icon"
                title="{{ _t('ml.edit_activity') if _t else 'Editar Actividad' }}"
                hx-get="{% if _counterpart %}/contraparte/{{ project.id }}/marco-logico/activity-form?activity_id={{ activity.id }}{% else %}/projects/{{ project.id }}/marco-logico/activity-form?activity_id={{ activity.id }}{% endif %}"
                hx-target="#indicator-modal-container"
                hx-swap="innerHTML"
                onclick="document.getElementById('indicator-modal-container').classList.add('active')"
            ><i data-lucide="pencil"></i></button>
            {% if not _counterpart %}
            <button
                class="btn btn-icon btn-danger"
                title="{{ _t('ml.delete') if _t else 'Eliminar' }}"
                hx-delete="/projects/activities/{{ activity.id }}"
                hx-target="#marco-logico-content"
                hx-swap="innerHTML"
                hx-confirm="{{ _t('ml.confirm_delete_activity') if _t else 'Eliminar esta actividad?' }}"
            ><i data-lucide="x"></i></button>
            {% endif %}
        </div>
    </div>

    <!-- Activity Indicators -->
    {% if activity.indicators %}
    <div class="ml-indicators-inline ml-node-children">
        {% for indicator in activity.indicators %}
            {% include "partials/projects/marco_logico_indicator.html" %}
        {% endfor %}
    </div>
    {% endif %}
</div>
