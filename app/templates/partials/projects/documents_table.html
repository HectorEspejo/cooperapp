{% set _t = t if t is defined else None %}
{% set _counterpart = is_counterpart if is_counterpart is defined else false %}
{% if documents %}
<div class="table-container">
    <table class="documents-table">
        <thead>
            <tr>
                <th class="col-preview">{{ _t('docs.col_preview') if _t else 'Vista' }}</th>
                <th class="col-name">{{ _t('docs.col_document') if _t else 'Documento' }}</th>
                <th class="col-categoria">{{ _t('docs.category') if _t else 'Categoria' }}</th>
                <th class="col-size">{{ _t('docs.col_size') if _t else 'Tamano' }}</th>
                <th class="col-date">{{ _t('docs.col_date') if _t else 'Fecha' }}</th>
                <th class="col-estado">{{ _t('docs.col_status') if _t else 'Estado' }}</th>
                <th class="col-vinculado">{{ _t('docs.col_linked') if _t else 'Vinculado' }}</th>
                <th class="col-actions">{{ _t('docs.col_actions') if _t else 'Acciones' }}</th>
            </tr>
        </thead>
        <tbody>
            {% for doc in documents %}
            {% set _download_url = '/contraparte/' + project.id|string + '/documents/' + doc.id|string + '/download' if _counterpart else '/api/documents/' + doc.id|string + '/download' %}
            <tr class="document-row {% if doc.sellado %}sealed{% endif %}">
                <td class="col-preview">
                    {% if doc.is_image %}
                    <div class="doc-thumbnail" {% if not _counterpart %}onclick="openDocumentPreview({{ doc.id }})"{% endif %}>
                        <img src="{{ _download_url }}" alt="{{ doc.original_filename }}">
                    </div>
                    {% elif doc.is_pdf %}
                    <div class="doc-thumbnail doc-pdf" {% if not _counterpart %}onclick="openDocumentPreview({{ doc.id }})"{% endif %}>
                        <span><i data-lucide="file-text"></i></span>
                    </div>
                    {% else %}
                    <div class="doc-thumbnail doc-file">
                        <span><i data-lucide="paperclip"></i></span>
                    </div>
                    {% endif %}
                </td>
                <td class="col-name">
                    <div class="doc-name-wrapper">
                        <span class="doc-filename" title="{{ doc.original_filename }}">
                            {{ doc.original_filename|truncate(35) }}
                        </span>
                        {% if doc.descripcion %}
                        <span class="doc-description">{{ (tc('document', doc.id, 'descripcion', doc.descripcion) if tc is defined else doc.descripcion)|truncate(50) }}</span>
                        {% endif %}
                    </div>
                </td>
                <td class="col-categoria">
                    <span class="categoria-badge categoria-{{ doc.categoria.value }}">
                        {{ categoria_nombres[doc.categoria.value] }}
                    </span>
                </td>
                <td class="col-size">
                    <span class="doc-size">{{ doc.file_size_human }}</span>
                </td>
                <td class="col-date">
                    <span class="doc-date">{{ doc.created_at.strftime('%d/%m/%Y') }}</span>
                </td>
                <td class="col-estado">
                    {% if doc.sellado %}
                    <span class="sellado-badge sellado" title="{{ _t('docs.status_sealed') if _t else 'Sellado' }} {{ doc.fecha_sellado.strftime('%d/%m/%Y %H:%M') if doc.fecha_sellado else '' }}">
                        <i data-lucide="lock"></i> {{ _t('docs.status_sealed') if _t else 'Sellado' }}
                    </span>
                    {% else %}
                    <span class="sellado-badge pendiente">
                        <i data-lucide="file-edit"></i> {{ _t('docs.status_pending') if _t else 'Pendiente' }}
                    </span>
                    {% endif %}
                </td>
                <td class="col-vinculado">
                    {% if doc.verification_sources %}
                    <span class="vinculado-badge vinculado" title="{{ doc.verification_sources|length }} {{ _t('docs.verification_sources_count') if _t else 'fuente(s) de verificacion' }}">
                        <i data-lucide="link"></i> {{ doc.verification_sources|length }}
                    </span>
                    {% else %}
                    <span class="vinculado-badge huerfano">
                        {{ _t('docs.status_unlinked') if _t else 'Sin vincular' }}
                    </span>
                    {% endif %}
                </td>
                <td class="col-actions">
                    <div class="action-buttons">
                        <a
                            href="{{ _download_url }}"
                            class="btn btn-icon btn-sm"
                            title="{{ _t('docs.download') if _t else 'Descargar' }}"
                            download
                        ><i data-lucide="download"></i></a>
                        {% if not _counterpart %}
                        {% if doc.is_image or doc.is_pdf %}
                        <button
                            class="btn btn-icon btn-sm"
                            title="{{ _t('docs.preview_action') if _t else 'Previsualizar' }}"
                            onclick="openDocumentPreview({{ doc.id }})"
                        ><i data-lucide="eye"></i></button>
                        {% endif %}
                        {% if not doc.sellado %}
                        {% if user and user.rol and user.rol.value in ['director', 'coordinador'] %}
                        <button
                            class="btn btn-icon btn-sm btn-success"
                            title="{{ _t('docs.seal_document') if _t else 'Sellar documento' }}"
                            hx-post="/projects/{{ project.id }}/documents/{{ doc.id }}/seal"
                            hx-target="#documents-content"
                            hx-swap="innerHTML"
                            hx-confirm="{{ _t('docs.confirm_seal') if _t else 'Sellar este documento? Esta accion no se puede deshacer.' }}"
                        ><i data-lucide="lock"></i></button>
                        {% endif %}
                        {% if user and user.rol and user.rol.value in ['director', 'coordinador', 'tecnico_sede', 'gestor_pais'] %}
                        <button
                            class="btn btn-icon btn-sm btn-danger"
                            title="{{ _t('ml.delete') if _t else 'Eliminar' }}"
                            hx-delete="/projects/{{ project.id }}/documents/{{ doc.id }}"
                            hx-target="#documents-content"
                            hx-swap="innerHTML"
                            hx-confirm="{{ _t('docs.confirm_delete') if _t else 'Eliminar este documento?' }}"
                        ><i data-lucide="x"></i></button>
                        {% endif %}
                        {% endif %}
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state documents-empty">
    <div class="empty-icon"><i data-lucide="file-text"></i></div>
    <h3>{{ _t('docs.no_documents') if _t else 'No hay documentos' }}</h3>
    <p>{{ _t('docs.upload_first') if _t else 'Sube el primer documento usando el formulario de arriba.' }}</p>
</div>
{% endif %}
