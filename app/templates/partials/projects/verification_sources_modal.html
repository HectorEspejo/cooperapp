{% set _t = t if t is defined else None %}
{% set _counterpart = is_counterpart if is_counterpart is defined else false %}
{% set _target_plural = 'activities' if target_type == 'activity' else target_type ~ 's' %}
<div class="modal-overlay" onclick="closeVerificationModal()">
    <div class="verification-modal ml-modal" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h3>{{ _t('vs.title') if _t else 'Fuentes de Verificacion' }}</h3>
            <button type="button" class="btn-close" onclick="closeVerificationModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Target Info -->
            <div class="verification-target-info">
                {% if target_type == 'indicator' %}
                <div class="target-badge target-indicator">
                    <span class="target-code">{{ target.codigo }}</span>
                    <span class="target-desc">{{ target.descripcion|truncate(80) }}</span>
                </div>
                {% else %}
                <div class="target-badge target-activity">
                    <span class="target-code">{{ target.numero }}</span>
                    <span class="target-desc">{{ target.descripcion|truncate(80) }}</span>
                </div>
                {% endif %}
            </div>

            <!-- Summary -->
            <div class="verification-summary">
                <div class="summary-stat">
                    <span class="stat-value">{{ summary.total }}</span>
                    <span class="stat-label">{{ _t('vs.total') if _t else 'Total' }}</span>
                </div>
                <div class="summary-stat stat-success">
                    <span class="stat-value">{{ summary.validados }}</span>
                    <span class="stat-label">{{ _t('vs.validated') if _t else 'Validados' }}</span>
                </div>
                <div class="summary-stat stat-warning">
                    <span class="stat-value">{{ summary.pendientes }}</span>
                    <span class="stat-label">{{ _t('vs.pending') if _t else 'Pendientes' }}</span>
                </div>
            </div>

            <!-- Add Source Form -->
            <div class="verification-add-form">
                <h4>{{ _t('vs.link_document') if _t else 'Vincular documento' }}</h4>
                <form
                    {% if _counterpart %}
                    hx-post="/contraparte/{{ project_id }}/{{ _target_plural }}/{{ target_id }}/verification-sources"
                    {% else %}
                    hx-post="/projects/{{ _target_plural }}/{{ target_id }}/verification-sources"
                    {% endif %}
                    hx-target=".verification-modal"
                    hx-swap="outerHTML"
                >
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label>{{ _t('vs.select_document') if _t else 'Documento' }}</label>
                            <select name="document_id" required>
                                <option value="">{{ _t('vs.select_document') if _t else 'Seleccionar documento...' }}</option>
                                {% for doc in available_documents %}
                                <option value="{{ doc.id }}">
                                    {{ doc.original_filename }} ({{ doc.categoria.value }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>{{ _t('vs.type') if _t else 'Tipo' }}</label>
                            <select name="tipo" required>
                                {% for tipo in tipos %}
                                <option value="{{ tipo.value }}">{{ tipo_nombres[tipo.value] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group" style="flex: 2;">
                            <label>{{ _t('vs.description_optional') if _t else 'Descripcion (opcional)' }}</label>
                            <input type="text" name="descripcion" placeholder="Descripcion...">
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary" style="align-self: flex-end;">
                            {{ _t('vs.link_button') if _t else '+ Vincular' }}
                        </button>
                    </div>
                </form>
            </div>

            <!-- Sources List -->
            <div class="verification-sources-list">
                <h4>{{ _t('vs.linked_sources') if _t else 'Fuentes vinculadas' }}</h4>
                {% if sources %}
                <div class="sources-grid">
                    {% for source in sources %}
                    {% include "partials/projects/verification_source_row.html" %}
                    {% endfor %}
                </div>
                {% else %}
                <div class="sources-empty">
                    <p>{{ _t('vs.no_sources') if _t else 'No hay fuentes de verificacion vinculadas.' }}</p>
                    <p class="text-muted">{{ _t('vs.use_form') if _t else 'Usa el formulario de arriba para vincular documentos.' }}</p>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeVerificationModal()">
                {{ _t('vs.close') if _t else 'Cerrar' }}
            </button>
        </div>
    </div>
</div>
