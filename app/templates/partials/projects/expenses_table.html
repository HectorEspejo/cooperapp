{% if expenses %}
<div class="table-container">
    <table class="expenses-table">
        <thead>
            <tr>
                <th class="col-date">Fecha</th>
                <th class="col-concept">Concepto</th>
                <th class="col-document">Doc</th>
                <th class="col-expedidor">Expedidor</th>
                <th class="col-partida">Partida</th>
                <th class="col-amount">Importe</th>
                <th class="col-imputable">Imputable</th>
                <th class="col-ubicacion">Ubicacion</th>
                <th class="col-estado">Estado</th>
                <th class="col-actions">Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for expense in expenses %}
            <tr id="expense-row-{{ expense.id }}" class="expense-row">
                <td class="col-date">{{ expense.fecha_factura.strftime('%d/%m/%Y') }}</td>
                <td class="col-concept">
                    <span class="concept-text" title="{{ expense.concepto }}">
                        {{ expense.concepto[:50] }}{% if expense.concepto|length > 50 %}...{% endif %}
                    </span>
                </td>
                <td class="col-document">
                    {% if expense.documento_path %}
                    <a href="/projects/{{ project.id }}/expenses/{{ expense.id }}/document"
                       class="doc-badge doc-attached" title="Ver documento" target="_blank">
                        <span class="doc-icon">üìé</span>
                    </a>
                    {% elif expense.estado.value in ['borrador', 'pendiente_revision'] %}
                    <button class="doc-badge doc-missing" title="Subir factura (requerido para validar)"
                            hx-get="/projects/{{ project.id }}/expenses/{{ expense.id }}/upload-modal"
                            hx-target="#expense-upload-modal-content"
                            hx-trigger="click"
                            onclick="openExpenseUploadModal()">
                        <span class="doc-icon">üìé</span>
                    </button>
                    {% else %}
                    <span class="doc-badge doc-none" title="Sin documento">-</span>
                    {% endif %}
                </td>
                <td class="col-expedidor">{{ expense.expedidor }}</td>
                <td class="col-partida">
                    <span class="partida-code">{{ expense.budget_line.code }}</span>
                </td>
                <td class="col-amount">
                    <span class="amount-cell">{{ "{:,.2f}".format(expense.cantidad_euros) }}</span>
                    {% if expense.moneda_original != 'EUR' %}
                    <span class="original-amount">({{ "{:,.2f}".format(expense.cantidad_original) }} {{ expense.moneda_original }})</span>
                    {% endif %}
                </td>
                <td class="col-imputable">
                    <span class="amount-cell">{{ "{:,.2f}".format(expense.cantidad_imputable) }}</span>
                    {% if expense.porcentaje < 100 %}
                    <span class="percentage-badge">{{ expense.porcentaje }}%</span>
                    {% endif %}
                </td>
                <td class="col-ubicacion">
                    <span class="ubicacion-badge ubicacion-{{ expense.ubicacion.value }}">
                        {{ 'Espana' if expense.ubicacion.value == 'espana' else 'Terreno' }}
                    </span>
                </td>
                <td class="col-estado">
                    <span class="estado-gasto-badge estado-gasto-{{ expense.estado.value }}">
                        {% if expense.estado.value == 'borrador' %}Borrador
                        {% elif expense.estado.value == 'pendiente_revision' %}Pendiente
                        {% elif expense.estado.value == 'validado' %}Validado
                        {% elif expense.estado.value == 'rechazado' %}Rechazado
                        {% elif expense.estado.value == 'justificado' %}Justificado
                        {% endif %}
                    </span>
                </td>
                <td class="col-actions">
                    <div class="action-buttons">
                        {% if expense.estado.value == 'borrador' %}
                        <button
                            class="btn-icon"
                            title="Editar"
                            hx-get="/projects/{{ project.id }}/expenses/{{ expense.id }}/edit"
                            hx-target="#expense-modal-content"
                            hx-trigger="click"
                            onclick="openExpenseModal()"
                        >‚úèÔ∏è</button>
                        {% if expense.documento_path %}
                        <button
                            class="btn-icon btn-success"
                            title="Validar"
                            hx-post="/projects/{{ project.id }}/expenses/{{ expense.id }}/validate"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                            hx-confirm="¬øValidar este gasto? Se actualizara el presupuesto ejecutado."
                        >‚úì</button>
                        {% else %}
                        <span class="btn-icon btn-disabled" title="Debe adjuntar factura para validar">‚úì</span>
                        {% endif %}
                        <button
                            class="btn-icon btn-danger"
                            title="Eliminar"
                            hx-delete="/projects/{{ project.id }}/expenses/{{ expense.id }}"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                            hx-confirm="¬øEliminar este gasto?"
                        >üóëÔ∏è</button>
                        {% elif expense.estado.value == 'pendiente_revision' %}
                        {% if expense.documento_path %}
                        <button
                            class="btn-icon btn-success"
                            title="Validar"
                            hx-post="/projects/{{ project.id }}/expenses/{{ expense.id }}/validate"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                            hx-confirm="¬øValidar este gasto?"
                        >‚úì</button>
                        {% else %}
                        <span class="btn-icon btn-disabled" title="Debe adjuntar factura para validar">‚úì</span>
                        {% endif %}
                        <button
                            class="btn-icon btn-warning"
                            title="Rechazar"
                            hx-post="/projects/{{ project.id }}/expenses/{{ expense.id }}/reject"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                            hx-confirm="¬øRechazar este gasto?"
                        >‚úó</button>
                        <button
                            class="btn-icon"
                            title="Volver a borrador"
                            hx-post="/projects/{{ project.id }}/expenses/{{ expense.id }}/revert"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                        >‚Ü©Ô∏è</button>
                        {% elif expense.estado.value == 'validado' %}
                        <button
                            class="btn-icon"
                            title="Volver a borrador"
                            hx-post="/projects/{{ project.id }}/expenses/{{ expense.id }}/revert"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                            hx-confirm="¬øRevertir a borrador? Se restara el importe del presupuesto ejecutado."
                        >‚Ü©Ô∏è</button>
                        {% elif expense.estado.value == 'rechazado' %}
                        <button
                            class="btn-icon"
                            title="Volver a borrador"
                            hx-post="/projects/{{ project.id }}/expenses/{{ expense.id }}/revert"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                        >‚Ü©Ô∏è</button>
                        <button
                            class="btn-icon btn-danger"
                            title="Eliminar"
                            hx-delete="/projects/{{ project.id }}/expenses/{{ expense.id }}"
                            hx-target="#expenses-content"
                            hx-select="#expenses-content"
                            hx-swap="outerHTML"
                            hx-confirm="¬øEliminar este gasto?"
                        >üóëÔ∏è</button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="empty-state expenses-empty">
    <div class="empty-icon">üìã</div>
    <h3>Sin gastos registrados</h3>
    <p>No hay gastos registrados para este proyecto. Haz clic en "Nuevo Gasto" para comenzar.</p>
</div>
{% endif %}
