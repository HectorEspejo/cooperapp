{% extends "base.html" %}

{% block title %}Auditoria - CooperApp{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1>Log de Auditoria</h1>
        <p class="text-muted">Registro de actividad del sistema</p>
    </div>
</div>

<!-- Summary Stats -->
<div class="audit-stats" id="audit-stats"></div>

<!-- Filters -->
<div class="audit-filters">
    <div class="audit-filters-group">
        <div class="audit-filter-item">
            <label for="audit-filter-accion"><i class="fas fa-filter"></i> Accion</label>
            <select id="audit-filter-accion" class="form-control" onchange="loadAuditLogs()">
                <option value="">Todas las acciones</option>
                {% for a in acciones %}
                <option value="{{ a.value }}">{{ a.value|replace('_', ' ')|title }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="audit-filter-item">
            <label for="audit-filter-desde"><i class="fas fa-calendar"></i> Desde</label>
            <input type="date" id="audit-filter-desde" class="form-control" onchange="loadAuditLogs()">
        </div>
        <div class="audit-filter-item">
            <label for="audit-filter-hasta"><i class="fas fa-calendar"></i> Hasta</label>
            <input type="date" id="audit-filter-hasta" class="form-control" onchange="loadAuditLogs()">
        </div>
        <div class="audit-filter-item audit-filter-actions">
            <button class="btn btn-sm btn-secondary" onclick="clearFilters()">
                <i class="fas fa-xmark"></i> Limpiar
            </button>
        </div>
    </div>
</div>

<!-- Audit Table -->
<div class="table-container">
    <table class="audit-table">
        <thead>
            <tr>
                <th>Fecha/Hora</th>
                <th>Actor</th>
                <th>Accion</th>
                <th>Recurso</th>
                <th>Detalle</th>
                <th>IP</th>
            </tr>
        </thead>
        <tbody id="audit-table-body">
            <tr><td colspan="6" class="text-center">
                <div class="audit-loading"><span class="audit-spinner"></span> Cargando registros...</div>
            </td></tr>
        </tbody>
    </table>
</div>

<!-- Pagination -->
<div class="audit-pagination" id="audit-pagination"></div>
{% endblock %}

{% block scripts %}
<script>
let currentPage = 1;
const pageSize = 50;

function loadAuditLogs(page) {
    if (page) currentPage = page;
    const accion = document.getElementById('audit-filter-accion').value;
    const desde = document.getElementById('audit-filter-desde').value;
    const hasta = document.getElementById('audit-filter-hasta').value;

    let url = '/api/audit-log?page=' + currentPage + '&page_size=' + pageSize + '&';
    if (accion) url += 'accion=' + accion + '&';
    if (desde) url += 'desde=' + desde + 'T00:00:00&';
    if (hasta) url += 'hasta=' + hasta + 'T23:59:59&';

    fetch(url)
        .then(r => r.json())
        .then(data => {
            renderStats(data);
            renderTable(data);
            renderPagination(data);
        });
}

function renderStats(data) {
    const container = document.getElementById('audit-stats');
    const total = data.total || 0;

    // Count by action type from current page items
    const counts = {};
    (data.items || []).forEach(log => {
        counts[log.accion] = (counts[log.accion] || 0) + 1;
    });

    container.innerHTML = `
        <div class="audit-stat-card">
            <div class="audit-stat-icon icon-primary"><i class="fas fa-list"></i></div>
            <div class="audit-stat-content">
                <span class="audit-stat-value">${total}</span>
                <span class="audit-stat-label">Total registros</span>
            </div>
        </div>
        <div class="audit-stat-card">
            <div class="audit-stat-icon icon-success"><i class="fas fa-right-to-bracket"></i></div>
            <div class="audit-stat-content">
                <span class="audit-stat-value">${counts['login'] || 0}</span>
                <span class="audit-stat-label">Inicios de sesion</span>
            </div>
        </div>
        <div class="audit-stat-card">
            <div class="audit-stat-icon icon-warning"><i class="fas fa-pen"></i></div>
            <div class="audit-stat-content">
                <span class="audit-stat-value">${(counts['create'] || 0) + (counts['update'] || 0)}</span>
                <span class="audit-stat-label">Cambios</span>
            </div>
        </div>
        <div class="audit-stat-card">
            <div class="audit-stat-icon icon-info"><i class="fas fa-download"></i></div>
            <div class="audit-stat-content">
                <span class="audit-stat-value">${(counts['download'] || 0) + (counts['export'] || 0) + (counts['upload'] || 0)}</span>
                <span class="audit-stat-label">Archivos</span>
            </div>
        </div>
    `;
}

function getAccionIcon(accion) {
    const icons = {
        login: 'right-to-bracket', logout: 'right-from-bracket', login_failed: 'shield',
        session_expired: 'clock', create: 'circle-plus', update: 'pen',
        delete: 'trash', status_change: 'arrows-rotate', upload: 'upload',
        download: 'download', export: 'file-export', role_change: 'user-gear',
        project_assign: 'user-plus', project_unassign: 'user-minus'
    };
    return icons[accion] || 'wave-square';
}

function getAccionClass(accion) {
    const classes = {
        login: 'audit-accion-success', logout: 'audit-accion-muted',
        login_failed: 'audit-accion-danger', session_expired: 'audit-accion-warning',
        create: 'audit-accion-info', update: 'audit-accion-info',
        delete: 'audit-accion-danger', status_change: 'audit-accion-warning',
        upload: 'audit-accion-success', download: 'audit-accion-muted',
        export: 'audit-accion-muted', role_change: 'audit-accion-warning',
        project_assign: 'audit-accion-info', project_unassign: 'audit-accion-warning'
    };
    return classes[accion] || '';
}

function formatTimestamp(ts) {
    const d = new Date(ts);
    const date = d.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
    const time = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    return `<span class="audit-date">${date}</span><span class="audit-time">${time}</span>`;
}

function formatDetail(detalle) {
    if (!detalle) return '<span class="audit-detail-empty">-</span>';
    const str = JSON.stringify(detalle);
    const short = str.length > 60 ? str.substring(0, 60) + '...' : str;
    return `<span class="audit-detail-text" title="${str.replace(/"/g, '&quot;')}">${short}</span>`;
}

function renderTable(data) {
    const tbody = document.getElementById('audit-table-body');
    if (!data.items || data.items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center">
            <div class="audit-empty">
                <i class="fas fa-inbox"></i>
                <p>No hay registros de auditoria.</p>
            </div>
        </td></tr>`;
        return;
    }
    tbody.innerHTML = data.items.map(log => `
        <tr class="audit-row">
            <td class="audit-cell-time">${formatTimestamp(log.timestamp)}</td>
            <td class="audit-cell-actor">
                <span class="badge badge-${log.actor_type}">${log.actor_type === 'internal' ? 'Interno' : 'Contraparte'}</span>
                <span class="audit-actor-name">${log.actor_label}</span>
            </td>
            <td>
                <span class="audit-accion-badge ${getAccionClass(log.accion)}">
                    <i class="fas fa-${getAccionIcon(log.accion)}"></i>
                    ${log.accion_display}
                </span>
            </td>
            <td class="audit-cell-recurso">
                ${log.recurso ? `<span class="audit-recurso-type">${log.recurso}</span>` : ''}
                ${log.recurso_id ? `<span class="audit-recurso-id">#${log.recurso_id}</span>` : ''}
                ${!log.recurso && !log.recurso_id ? '<span class="audit-detail-empty">-</span>' : ''}
            </td>
            <td>${formatDetail(log.detalle)}</td>
            <td class="audit-cell-ip">${log.ip_address || '<span class="audit-detail-empty">-</span>'}</td>
        </tr>
    `).join('');
}

function renderPagination(data) {
    const container = document.getElementById('audit-pagination');
    const totalPages = Math.ceil(data.total / pageSize);
    if (totalPages <= 1) { container.innerHTML = ''; return; }

    let pages = '';
    for (let i = 1; i <= totalPages && i <= 10; i++) {
        if (i === currentPage) {
            pages += `<span class="audit-page-btn active">${i}</span>`;
        } else {
            pages += `<button class="audit-page-btn" onclick="loadAuditLogs(${i})">${i}</button>`;
        }
    }
    if (totalPages > 10) pages += `<span class="audit-page-ellipsis">...</span>`;

    container.innerHTML = `
        <span class="audit-page-info">Mostrando ${(currentPage-1)*pageSize + 1}-${Math.min(currentPage*pageSize, data.total)} de ${data.total}</span>
        <div class="audit-page-controls">
            ${currentPage > 1 ? `<button class="audit-page-btn" onclick="loadAuditLogs(${currentPage-1})"><i class="fas fa-chevron-left"></i></button>` : ''}
            ${pages}
            ${currentPage < totalPages ? `<button class="audit-page-btn" onclick="loadAuditLogs(${currentPage+1})"><i class="fas fa-chevron-right"></i></button>` : ''}
        </div>
    `;
}

function clearFilters() {
    document.getElementById('audit-filter-accion').value = '';
    document.getElementById('audit-filter-desde').value = '';
    document.getElementById('audit-filter-hasta').value = '';
    currentPage = 1;
    loadAuditLogs();
}

document.addEventListener('DOMContentLoaded', loadAuditLogs);
</script>
{% endblock %}
