{% extends "base.html" %}

{% block title %}Nuevo Proyecto - CooperApp{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/projects" class="btn btn-secondary">← Volver</a>
    <h1>Nuevo Proyecto</h1>
</div>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

<div class="form-card">
    <form method="POST" action="/projects/new" class="project-form">
        <div class="form-grid">
            <div class="form-group">
                <label for="codigo_contable">Código Contable *</label>
                <input type="text" id="codigo_contable" name="codigo_contable" required
                    placeholder="Ej: 21.17.13">
            </div>
            <div class="form-group">
                <label for="codigo_area">Código de Área *</label>
                <input type="text" id="codigo_area" name="codigo_area" required
                    placeholder="Ej: 2017.AACID.Haití">
            </div>
        </div>

        <div class="form-group">
            <label for="titulo">Título del Proyecto *</label>
            <input type="text" id="titulo" name="titulo" required
                placeholder="Nombre completo del proyecto">
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="pais">País *</label>
                <input type="text" id="pais" name="pais" required list="paises-list"
                    placeholder="País de ejecución">
                <datalist id="paises-list">
                    {% for p in paises %}
                    <option value="{{ p }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="form-group">
                <label for="sector">Sector *</label>
                <input type="text" id="sector" name="sector" required list="sectores-list"
                    placeholder="Sector de intervención">
                <datalist id="sectores-list">
                    {% for s in sectores %}
                    <option value="{{ s }}">
                    {% endfor %}
                </datalist>
            </div>
        </div>

        <div class="form-grid form-grid-3">
            <div class="form-group">
                <label for="estado">Estado *</label>
                <select id="estado" name="estado" required>
                    {% for e in estados %}
                    <option value="{{ e.value }}">{{ e.value|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="tipo">Tipo *</label>
                <select id="tipo" name="tipo" required>
                    {% for t in tipos %}
                    <option value="{{ t.value }}">{{ t.value|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="financiador">Financiador *</label>
                <select id="financiador" name="financiador" required onchange="showFunderInfo(this.value)">
                    <option value="">Seleccionar...</option>
                    {% for f in financiadores %}
                    <option value="{{ f.value }}">{{ f.value }}</option>
                    {% endfor %}
                </select>
                <div id="funder-info" class="funder-info-tooltip" style="display: none;"></div>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="subvencion">Subvención (€) *</label>
                <input type="number" id="subvencion" name="subvencion" required step="0.01" min="0"
                    placeholder="0.00">
            </div>
            <div class="form-group">
                <label for="cuenta_bancaria">Cuenta Bancaria (IBAN)</label>
                <input type="text" id="cuenta_bancaria" name="cuenta_bancaria" maxlength="34"
                    placeholder="ES00 0000 0000 0000 0000 0000">
            </div>
        </div>

        <div class="form-grid form-grid-3">
            <div class="form-group">
                <label for="fecha_inicio">Fecha de Inicio *</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio" required>
            </div>
            <div class="form-group">
                <label for="fecha_finalizacion">Fecha de Finalización *</label>
                <input type="date" id="fecha_finalizacion" name="fecha_finalizacion" required>
            </div>
            <div class="form-group">
                <label for="fecha_justificacion">Fecha de Justificación</label>
                <input type="date" id="fecha_justificacion" name="fecha_justificacion">
            </div>
        </div>

        <div class="form-group checkbox-group">
            <label>
                <input type="checkbox" name="ampliado" value="true">
                Proyecto ampliado
            </label>
        </div>

        <!-- ODS Section -->
        <div class="form-section">
            <h3>Objetivos de Desarrollo Sostenible (ODS)</h3>
            <p class="help-text">Selecciona los ODS relacionados con este proyecto</p>
            <div class="ods-grid">
                {% for ods in ods_list %}
                <label class="ods-checkbox" title="ODS {{ ods.numero }}: {{ ods.nombre }}">
                    <input type="checkbox" name="ods_ids[]" value="{{ ods.id }}">
                    <span class="ods-number">{{ ods.numero }}</span>
                    <span class="ods-name">{{ ods.nombre }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <!-- Plazos Section -->
        <div class="form-section">
            <div class="section-header">
                <h3>Plazos</h3>
                <button type="button" class="btn btn-sm btn-secondary" onclick="addPlazo()">
                    + Añadir Plazo
                </button>
            </div>
            <div id="plazos-container">
                <!-- Plazos will be added here dynamically -->
            </div>
            <p class="help-text">Añade los plazos importantes del proyecto (entregas, informes, etc.)</p>
        </div>

        <div class="form-actions">
            <a href="/projects" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Crear Proyecto</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
let plazoIndex = 0;

// Funder information data
const funderInfo = {
    'AACID': {
        name: 'Agencia Andaluza de Cooperacion Internacional para el Desarrollo',
        lines: '20 partidas presupuestarias',
        indirectos: 'Sin limite explicito de costes indirectos',
        especial: null
    },
    'AECID': {
        name: 'Agencia Espanola de Cooperacion Internacional para el Desarrollo',
        lines: '12 partidas presupuestarias',
        indirectos: 'Maximo 10% de costes indirectos',
        especial: null
    },
    'Diputación de Málaga': {
        name: 'Diputacion Provincial de Malaga',
        lines: '9 partidas presupuestarias',
        indirectos: 'Maximo 8% de costes indirectos',
        especial: 'Justificacion max. 3 meses tras fin de ejecucion'
    },
    'Ayuntamiento de Málaga': {
        name: 'Ayuntamiento de Malaga',
        lines: '6 partidas presupuestarias (estructura simplificada)',
        indirectos: 'Maximo 7% de costes indirectos',
        especial: 'Personal max. 50% del total. Auditoria opcional si subvencion < 30.000 EUR'
    }
};

function showFunderInfo(value) {
    const infoDiv = document.getElementById('funder-info');
    const info = funderInfo[value];

    if (info) {
        let html = `<strong>${info.name}</strong><br>`;
        html += `<span class="info-line">${info.lines}</span><br>`;
        html += `<span class="info-line">${info.indirectos}</span>`;
        if (info.especial) {
            html += `<br><span class="info-line info-special">${info.especial}</span>`;
        }
        infoDiv.innerHTML = html;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

function addPlazo() {
    const container = document.getElementById('plazos-container');
    const plazoHtml = `
        <div class="plazo-item" id="plazo-${plazoIndex}">
            <div class="plazo-fields">
                <input type="text" name="plazo_titulo[]" placeholder="Título del plazo" required>
                <input type="date" name="plazo_fecha[]" required>
                <button type="button" class="btn btn-icon btn-danger" onclick="removePlazo(${plazoIndex})"><i class="fas fa-xmark"></i></button>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', plazoHtml);
    plazoIndex++;
}

function removePlazo(index) {
    const plazo = document.getElementById(`plazo-${index}`);
    if (plazo) {
        plazo.remove();
    }
}
</script>
{% endblock %}
