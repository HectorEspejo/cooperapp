{% extends "base.html" %}

{% block title %}Editar {{ project.titulo }} - CooperApp{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/projects/{{ project.id }}" class="btn btn-secondary">← Volver</a>
    <h1>Editar Proyecto</h1>
</div>

{% if error %}
<div class="alert alert-error">
    {{ error }}
</div>
{% endif %}

<div class="form-card">
    <form method="POST" action="/projects/{{ project.id }}/edit" class="project-form">
        <div class="form-grid">
            <div class="form-group">
                <label for="codigo_contable">Código Contable *</label>
                <input type="text" id="codigo_contable" name="codigo_contable" required
                    value="{{ project.codigo_contable }}">
            </div>
            <div class="form-group">
                <label for="codigo_area">Código de Área *</label>
                <input type="text" id="codigo_area" name="codigo_area" required
                    value="{{ project.codigo_area }}">
            </div>
        </div>

        <div class="form-group">
            <label for="titulo">Título del Proyecto *</label>
            <input type="text" id="titulo" name="titulo" required
                value="{{ project.titulo }}">
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="pais">País *</label>
                <input type="text" id="pais" name="pais" required list="paises-list"
                    value="{{ project.pais }}">
                <datalist id="paises-list">
                    {% for p in paises %}
                    <option value="{{ p }}">
                    {% endfor %}
                </datalist>
            </div>
            <div class="form-group">
                <label for="sector">Sector *</label>
                <input type="text" id="sector" name="sector" required list="sectores-list"
                    value="{{ project.sector }}">
                <datalist id="sectores-list">
                    {% for s in sectores %}
                    <option value="{{ s }}">
                    {% endfor %}
                </datalist>
            </div>
        </div>

        <div class="form-grid form-grid-3">
            <div class="form-group">
                <label for="estado">Estado *</label>
                <select id="estado" name="estado" required>
                    {% for e in estados %}
                    <option value="{{ e.value }}" {% if project.estado == e %}selected{% endif %}>
                        {{ e.value|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="tipo">Tipo *</label>
                <select id="tipo" name="tipo" required>
                    {% for t in tipos %}
                    <option value="{{ t.value }}" {% if project.tipo == t %}selected{% endif %}>
                        {{ t.value|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="financiador">Financiador *</label>
                <select id="financiador" name="financiador" required onchange="showFunderInfo(this.value)">
                    {% for f in financiadores %}
                    <option value="{{ f.value }}" {% if project.financiador == f %}selected{% endif %}>
                        {{ f.value }}
                    </option>
                    {% endfor %}
                </select>
                <div id="funder-info" class="funder-info-tooltip" style="display: none;"></div>
            </div>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label for="subvencion">Subvención (€) *</label>
                <input type="number" id="subvencion" name="subvencion" required step="0.01" min="0"
                    value="{{ project.subvencion }}">
            </div>
            <div class="form-group">
                <label for="cuenta_bancaria">Cuenta Bancaria (IBAN)</label>
                <input type="text" id="cuenta_bancaria" name="cuenta_bancaria" maxlength="34"
                    value="{{ project.cuenta_bancaria or '' }}"
                    placeholder="ES00 0000 0000 0000 0000 0000">
            </div>
        </div>

        {% if project.estado.value == 'formulacion' %}
        <div class="form-grid form-grid-3">
            <div class="form-group">
                <label for="fecha_inicio">Fecha de Inicio *</label>
                <input type="date" id="fecha_inicio" name="fecha_inicio" required
                    value="{{ project.fecha_inicio }}">
            </div>
            <div class="form-group">
                <label for="fecha_finalizacion">Fecha de Finalizacion *</label>
                <input type="date" id="fecha_finalizacion" name="fecha_finalizacion" required
                    value="{{ project.fecha_finalizacion }}">
            </div>
            <div class="form-group">
                <label for="fecha_justificacion">Fecha de Justificacion</label>
                <input type="date" id="fecha_justificacion" name="fecha_justificacion"
                    value="{{ project.fecha_justificacion or '' }}">
            </div>
        </div>

        <div class="form-group checkbox-group">
            <label>
                <input type="checkbox" name="ampliado" value="true"
                    {% if project.ampliado %}checked{% endif %}>
                Proyecto ampliado
            </label>
        </div>
        {% else %}
        <div class="form-grid form-grid-3">
            <div class="form-group">
                <label>Fecha de Inicio</label>
                <input type="date" disabled value="{{ project.fecha_inicio }}">
                <input type="hidden" name="fecha_inicio" value="{{ project.fecha_inicio }}">
            </div>
            <div class="form-group">
                <label>Fecha de Finalizacion</label>
                <input type="date" disabled value="{{ project.fecha_finalizacion }}">
                <input type="hidden" name="fecha_finalizacion" value="{{ project.fecha_finalizacion }}">
            </div>
            <div class="form-group">
                <label>Fecha de Justificacion</label>
                <input type="date" disabled value="{{ project.fecha_justificacion or '' }}">
                <input type="hidden" name="fecha_justificacion" value="{{ project.fecha_justificacion or '' }}">
            </div>
        </div>
        <input type="hidden" name="ampliado" value="{{ 'true' if project.ampliado else '' }}">

        {% if aplazamiento_pendiente %}
        <div class="alert alert-warning aplazamiento-alert">
            <i class="fas fa-clock"></i>
            <span>Hay una solicitud de aplazamiento pendiente de aprobacion (solicitada por {{ aplazamiento_pendiente.solicitante.nombre_completo }} el {{ aplazamiento_pendiente.created_at.strftime('%d/%m/%Y') }}).</span>
        </div>
        {% elif user and user.rol and user.rol.value in ['director', 'coordinador', 'tecnico_sede'] %}
        <div class="aplazamiento-action">
            <button type="button" class="btn btn-warning" onclick="document.getElementById('aplazamiento-modal-container').style.display='block'">
                <i class="fas fa-calendar-plus"></i> Solicitar Aplazamiento de Fechas
            </button>
        </div>
        {% endif %}
        {% endif %}

        <!-- ODS Section -->
        <div class="form-section">
            <h3>Objetivos de Desarrollo Sostenible (ODS)</h3>
            <p class="help-text">Selecciona los ODS relacionados con este proyecto</p>
            <div class="ods-grid">
                {% set project_ods_ids = project.ods_objetivos | map(attribute='id') | list %}
                {% for ods in ods_list %}
                <label class="ods-checkbox" title="ODS {{ ods.numero }}: {{ ods.nombre }}">
                    <input type="checkbox" name="ods_ids[]" value="{{ ods.id }}"
                        {% if ods.id in project_ods_ids %}checked{% endif %}>
                    <span class="ods-number">{{ ods.numero }}</span>
                    <span class="ods-name">{{ ods.nombre }}</span>
                </label>
                {% endfor %}
            </div>
        </div>

        <div class="form-actions">
            <a href="/projects/{{ project.id }}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        </div>
    </form>
</div>

{% if project.estado.value != 'formulacion' and not aplazamiento_pendiente and user and user.rol and user.rol.value in ['director', 'coordinador', 'tecnico_sede'] %}
<div id="aplazamiento-modal-container" style="display:none">
    {% include "partials/projects/aplazamiento_form.html" %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Funder information data
const funderInfo = {
    'AACID': {
        name: 'Agencia Andaluza de Cooperacion Internacional para el Desarrollo',
        lines: '20 partidas presupuestarias',
        indirectos: 'Sin limite explicito de costes indirectos',
        especial: null
    },
    'AECID': {
        name: 'Agencia Espanola de Cooperacion Internacional para el Desarrollo',
        lines: '12 partidas presupuestarias',
        indirectos: 'Maximo 10% de costes indirectos',
        especial: null
    },
    'Diputación de Málaga': {
        name: 'Diputacion Provincial de Malaga',
        lines: '9 partidas presupuestarias',
        indirectos: 'Maximo 8% de costes indirectos',
        especial: 'Justificacion max. 3 meses tras fin de ejecucion'
    },
    'Ayuntamiento de Málaga': {
        name: 'Ayuntamiento de Malaga',
        lines: '6 partidas presupuestarias (estructura simplificada)',
        indirectos: 'Maximo 7% de costes indirectos',
        especial: 'Personal max. 50% del total. Auditoria opcional si subvencion < 30.000 EUR'
    }
};

function showFunderInfo(value) {
    const infoDiv = document.getElementById('funder-info');
    const info = funderInfo[value];

    if (info) {
        let html = `<strong>${info.name}</strong><br>`;
        html += `<span class="info-line">${info.lines}</span><br>`;
        html += `<span class="info-line">${info.indirectos}</span>`;
        if (info.especial) {
            html += `<br><span class="info-line info-special">${info.especial}</span>`;
        }
        infoDiv.innerHTML = html;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

// Show info for initially selected funder
document.addEventListener('DOMContentLoaded', function() {
    const select = document.getElementById('financiador');
    if (select && select.value) {
        showFunderInfo(select.value);
    }
});
</script>
{% endblock %}
